#!/bin/sh
if [ -z "$dotfiles" ]; then 
    notify-send "\$dotfiles not defined ðŸ‘Ž" 
    exit 1
fi
if [ "$1" != "selfexec" ]; then
    exec setsid "$0" selfexec "$@"
fi

cache_dir="$XDG_CACHE_HOME/dotfiles"
mkdir -p "$cache_dir"

LOCKFILE="/tmp/screenshot.lock"
if [ -f "$LOCKFILE" ]; then
    old_pid=$(cat "$LOCKFILE")
    kill -TERM -"$old_pid" 2>/dev/null
    rm -f "$LOCKFILE"
    shotgun - | tee "$cache_dir/screenshot.png" | xclip -t 'image/png' -selection clipboard
    notify-send -t 1000 "Screenshot Taken ðŸ“¸"
    setsid ffplay -nodisp -autoexit "$dotfiles/media/camera.ogg" &
    exit 0
else
    echo $$ > "$LOCKFILE"
    trap 'rm -f "$LOCKFILE"' EXIT
    selection="$(hacksaw -f "%i %g")"
    window_id="$(echo "$selection" | cut -d' ' -f1)"
    geometry="$(echo "$selection" | cut -d' ' -f2)"
    shotgun -i "$window_id" -g "$geometry" - | tee "$cache_dir/screenshot.png" | xclip -t 'image/png' -selection clipboard
    rm -f "$LOCKFILE"
    exit 0
fi
